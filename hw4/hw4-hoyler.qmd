---
title: "Sobol Homework EDS 230"
auhtor: "Haylee Oyler"
format: 
  html: 
    embed-resources: true
execute: 
  warning: false
  message: false
---
Author: Haylee Oyler

# Part 1 

#### Sobol sensitivity analysis for risk assessment of uranium in groundwater

The sensitivity analysis conducted in this paper investigates the most important inputs and parameters that affect uranium concentrations in groundwater. The authors found that the distribution coefficient (kd) had the highest sensitivity index. This coefficient controls the sorption of uranium into soil particles. Concentration of Uranium and the hydraulic conductivity were also important. Overall, these results greatly expand conservationist's and manager's understanding of how uranium pollution spreads. If you know what parameters the pollution is most sensitive to, then you can allocate resources more efficiently towards affecting those parameters. 

# Part 2

```{r}
library(sensitivity)
library(tidyverse)
library(gridExtra)
library(purrr)
library(ggpubr)
library(here)
```

### Parameter and Input Uncertainty

```{r}
source(here("hw4/Catm.R"))

# generate two examples of random number from parameter distributions
np <- 1000
k_o <- rnorm(mean = 0.1, sd = 0.1 * 0.01, n = np)
k_d <- rnorm(mean = 0.7, sd = 0.7 * 0.01, n = np)
# Changing the units here because of the discussion we had in section
v <- rnorm(mean = 3, sd = .5, n = np)
height <- runif(min = 3.5, max = 5.5, n = np)

X1 <- cbind.data.frame(k_o, k_d, v, height = height)

# repeat sampling
k_o <- rnorm(mean = 0.1, sd = 0.1 * 0.01, n = np)
k_d <- rnorm(mean = 0.7, sd = 0.7 * 0.01, n = np)
# Changing the units here because of the discussion we had in section
v <- rnorm(mean = 3, sd = .5, n = np)
height <- runif(min = 3.5, max = 5.5, n = np)

X2 <- cbind.data.frame(k_o, k_d, v, height = height)

sens_Catm_Sobol <- sobolSalt(model = NULL, X1, X2, nboot = 100)

```


### Run the CATM model

```{r}
# Run model for all parameter sets and assign names
parms <- as.data.frame(sens_Catm_Sobol$X)
colnames(parms) <- colnames(X1)
res <- pmap_dbl(parms, Catm)

# Run sensitivity analysis
sens_Catm_Sobol <- sensitivity::tell(sens_Catm_Sobol, res, res.names = "ga")
```


### Plotting

```{r}
# graph two most sensitive parameters
both <- cbind.data.frame(parms, output = sens_Catm_Sobol$y)

# look at overall output
ggplot(both, aes(x = output)) +
  geom_histogram(color = "grey15", fill = "lightblue") +
  geom_vline(xintercept = mean(both$output), col = "firebrick") +
  labs(title = "Overall Conductance Outputs Generated by Sobol",
       x = "Atmospheric Conductance (mm/s)",
       y = "count")

# look at response of conductance to the two interesting variables
ggplot(both, aes(v, output, col = height)) +
  geom_point() +
  labs(y = "Conductance (mm/s)", 
       x = "Windspeed",
       title = "Condutance and Windspeed",
       col = "Height")

# look at response of conductance to the two interesting variables
ggplot(both, aes(height, output, col = v)) +
  geom_point() +
  labs(y = "Conductance (mm/s)", 
       x = "Height",
       title = "Condutance and Vegetation Height",
       col = "Windspeed")

```

### Sobol Indices

```{r}
# View main effect (first order) and total effect 
print(sens_Catm_Sobol)
```


### Conclusions

In the example we did in class, `kd` (the scalar for zero plane displacement) was the parameter our atmospheric conductance model was most sensitive to. `ko` and `windspeed` were the next most important and they had similar coefficients. `height` was the parameter the model was least sensitive to. 

Now that we've changed the parameters and inputs such that windspeeds are higher and more variable and vegetation is shorter, we see that conductance is much more sensitive to windspeed. It is secondarily sensitive to height, but the sensitivity is dominated by windspeed. This makes sense because we've changed the context of our study to a place with higher windspeeds, so conductance responds accordingly with that change. 
